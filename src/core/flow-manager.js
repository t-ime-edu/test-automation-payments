/**
 * ÌîåÎ°úÏö∞ Îß§ÎãàÏ†Ä
 * Ï†ÑÏ≤¥ ÌÖåÏä§Ìä∏ ÌîåÎ°úÏö∞Î•º Îã®Í≥ÑÎ≥ÑÎ°ú Í¥ÄÎ¶¨
 */

import { Logger } from '../utils/logger.js';
import { PerformanceMonitor } from '../utils/performance.js';
import { CourseListPage } from '../pages/course-list-page.js';
import { BasicInfoPage } from '../pages/basic-info-page.js';
import { DetailedInfoPage } from '../pages/detailed-info-page.js';
import { ClassSelectionPage } from '../pages/class-selection-page.js';
import { PaymintPaymentPage } from '../pages/paymint-payment-page.js';
import { WaitingPage } from '../pages/waiting-page.js';
import { config } from '../config/index.js';

export class FlowManager {
  constructor(page, sessionId, monitor = null) {
    this.page = page;
    this.sessionId = sessionId;
    this.monitor = monitor; // ConcurrentMonitor
    this.logger = new Logger(`FlowManager-${sessionId}`);
    this.performanceMonitor = new PerformanceMonitor(sessionId);

    // ÌéòÏù¥ÏßÄ Ïù∏Ïä§ÌÑ¥Ïä§ Ï†ÄÏû•Ïö©
    this.classSelectionPage = null; // Ï∂îÍ∞Ä

    // ÏóêÎü¨ Ïä§ÌÅ¨Î¶∞ÏÉ∑ ÌôúÏÑ±Ìôî Ïó¨Î∂Ä (configÏóêÏÑú Í¥ÄÎ¶¨)
    // Í∞úÎ∞ú/ÎîîÎ≤ÑÍπÖ: true (Í∏∞Î≥∏Í∞í), ÎåÄÎüâ ÌÖåÏä§Ìä∏: false (ÏÑ±Îä• ÏµúÏ†ÅÌôî)
    this.enableScreenshots = config.enableScreenshots;

    this.result = {
      success: false,
      stepTimes: {},
      errors: [],
      screenshots: [],
      classSelection: null
    };
  }

  /**
   * Ïú†ÎüâÏ†úÏñ¥Î•º Ï†ÅÏö©Ìïú ÏûëÏóÖ Ïã§Ìñâ
   */
  async _executeWithRateLimit(actionName, actionFn) {
    if (this.monitor && typeof this.monitor.waitForRateLimit === 'function') {
      await this.monitor.waitForRateLimit();
    }
    this.logger.info(`[Rate Limited] Executing: ${actionName}`);
    return await actionFn();
  }

  /**
   * ÎåÄÍ∏∞ ÌéòÏù¥ÏßÄ Ï≤òÎ¶¨
   */
  async _handleWaitingPageIfPresent() {
    const waitingPage = new WaitingPage(this.page, this.sessionId);
    const handled = await waitingPage.handleWaitingIfPresent();

    if (!handled) {
      throw new Error('Failed to pass through waiting page');
    }
  }

  /**
   * Ï†ÑÏ≤¥ ÌîåÎ°úÏö∞ Ïã§Ìñâ
   */
  async executeFullFlow(studentInfo) {
    this.logger.info('Executing full registration flow...');

    try {
      // Step 1: ÏàòÍ∞ïÏã†Ï≤≠ Î™©Î°ùÏóêÏÑú ÏΩîÏä§ ÏÑ†ÌÉù
      await this._step1_SelectCourse(studentInfo);

      // Step 2: Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏûÖÎ†•
      await this._step2_FillBasicInfo(studentInfo);

      // Step 3: ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÏûÖÎ†•
      await this._step3_FillDetailedInfo(studentInfo);

      // Step 4: ÏàòÍ∞ïÎ∞ò Î∞è Í≤∞Ï†ú Î∞©Î≤ï ÏÑ†ÌÉù
      await this._step4_SelectClassAndPayment();

      // Step 5: Paymint Í≤∞Ï†ú Ï≤òÎ¶¨
      await this._step5_ProcessPayment();

      this.result.success = true;
      this.logger.info('‚úì Full flow completed successfully');

    } catch (error) {
      this.logger.error('Flow execution failed:', error);
      this.result.success = false;
      this.result.errors.push({
        step: 'flow-execution',
        message: error.message,
        timestamp: new Date()
      });
    }

    return this.result;
  }

  /**
   * Step 1: ÏΩîÏä§ ÏÑ†ÌÉù
   */
  async _step1_SelectCourse(studentInfo) {
    this.logger.info('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    this.logger.info('üìù Step 1: Selecting course');
    this.logger.info('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

    // Î™®ÎãàÌÑ∞Ïóê Îã®Í≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
    if (this.monitor) {
      this.monitor.updateSessionStep(this.sessionId, 'step1-course');
    }

    this.performanceMonitor.startTimer('course-selection');

    try {
      const courseListPage = new CourseListPage(this.page, this.sessionId);

      this.logger.info('Navigating to course list page...');
      await this._executeWithRateLimit('navigate-to-course-list', () => courseListPage.navigate());

      // ÎåÄÍ∏∞ ÌéòÏù¥ÏßÄ ÌôïÏù∏
      await this._handleWaitingPageIfPresent();

      if (!studentInfo.acadCd) {
        throw new Error('AcadCd is required');
      }

      this.logger.info(`Target academy code: ${studentInfo.acadCd}`);
      const selectedCourse = await this._executeWithRateLimit('apply-to-course',
        () => courseListPage.applyToFirstAvailableCourse(studentInfo.acadCd));

      // ÎåÄÍ∏∞ ÌéòÏù¥ÏßÄ ÌôïÏù∏
      await this._handleWaitingPageIfPresent();

      this.logger.info(`‚úì Course selected: ${selectedCourse.title} (Status: ${selectedCourse.status})`);
      this.result.courseInfo = selectedCourse;

      const elapsedTime = this.performanceMonitor.endTimer('course-selection');
      this.result.stepTimes['course-selection'] = elapsedTime;
      this.logger.info(`‚è±Ô∏è  Step 1 completed in ${Math.round(elapsedTime/1000)}s`);

    } catch (error) {
      const elapsedTime = this.performanceMonitor.endTimer('course-selection');
      this.logger.error(`‚úó Step 1 FAILED after ${Math.round(elapsedTime/1000)}s`);
      this.logger.error(`Error details: ${error.message}`);

      // Î™®ÎãàÌÑ∞Ïóê ÏóêÎü¨ Í∏∞Î°ù
      if (this.monitor) {
        this.monitor.recordError(this.sessionId, 'step1-course', error);
      }

      // ÏóêÎü¨ Ïä§ÌÅ¨Î¶∞ÏÉ∑ Ï∫°Ï≤ò (ÌôòÍ≤ΩÎ≥ÄÏàòÎ°ú Ï†úÏñ¥)
      if (this.enableScreenshots) {
        try {
          await this.page.screenshot({ path: `public/screenshots/error-step1-${this.sessionId}.png` });
          this.logger.info('Error screenshot saved');
        } catch (screenshotError) {
          this.logger.warn('Failed to capture error screenshot');
        }
      }

      throw new Error(`Course selection failed: ${error.message}`);
    }
  }

  /**
   * Step 2: Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏûÖÎ†•
   */
  async _step2_FillBasicInfo(studentInfo) {
    this.logger.info('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    this.logger.info('üìù Step 2: Filling basic info');
    this.logger.info('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

    if (this.monitor) this.monitor.updateSessionStep(this.sessionId, 'step2-basic');
    this.performanceMonitor.startTimer('basic-info');

    try {
      const basicInfoPage = new BasicInfoPage(this.page, this.sessionId);

      this.logger.info('Waiting for basic info page to load...');
      await basicInfoPage.waitForPageLoad();

      // ÎåÄÍ∏∞ ÌéòÏù¥ÏßÄ ÌôïÏù∏
      await this._handleWaitingPageIfPresent();

      this.logger.info(`Filling info: ${studentInfo.name} (${studentInfo.phone})`);
      await this._executeWithRateLimit('fill-basic-info', () => basicInfoPage.fillBasicInfo(studentInfo));
      await this._executeWithRateLimit('click-next-button-step2', () => basicInfoPage.clickNextButton());

      const elapsedTime = this.performanceMonitor.endTimer('basic-info');
      this.result.stepTimes['basic-info'] = elapsedTime;
      this.logger.info(`‚úì Basic info filled successfully`);
      this.logger.info(`‚è±Ô∏è  Step 2 completed in ${Math.round(elapsedTime/1000)}s`);

    } catch (error) {
      const elapsedTime = this.performanceMonitor.endTimer('basic-info');
      this.logger.error(`‚úó Step 2 FAILED after ${Math.round(elapsedTime/1000)}s`);
      this.logger.error(`Error details: ${error.message}`);

      if (this.monitor) this.monitor.recordError(this.sessionId, 'step2-basic', error);

      if (this.enableScreenshots) {
        try {
          await this.page.screenshot({ path: `public/screenshots/error-step2-${this.sessionId}.png` });
          this.logger.info('Error screenshot saved');
        } catch (screenshotError) {
          this.logger.warn('Failed to capture error screenshot');
        }
      }

      throw new Error(`Basic info failed: ${error.message}`);
    }
  }

  /**
   * Step 3: ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÏûÖÎ†•
   */
  async _step3_FillDetailedInfo(studentInfo) {
    this.logger.info('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    this.logger.info('üìù Step 3: Filling detailed info');
    this.logger.info('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

    if (this.monitor) this.monitor.updateSessionStep(this.sessionId, 'step3-detailed');
    this.performanceMonitor.startTimer('detailed-info');

    try {
      const detailedInfoPage = new DetailedInfoPage(this.page, this.sessionId);

      this.logger.info('Waiting for detailed info page to load...');
      await detailedInfoPage.waitForPageLoad();

      // ÎåÄÍ∏∞ ÌéòÏù¥ÏßÄ ÌôïÏù∏
      await this._handleWaitingPageIfPresent();

      this.logger.info(`Filling detailed info: School=${studentInfo.schoolName}, Grade=${studentInfo.grade}`);
      await this._executeWithRateLimit('fill-detailed-info', () => detailedInfoPage.fillDetailedInfo(studentInfo));
      await this._executeWithRateLimit('agree-privacy-policy', () => detailedInfoPage.agreeToPrivacyPolicy());
      await this._executeWithRateLimit('click-next-button-step3', () => detailedInfoPage.clickNextButton());

      const elapsedTime = this.performanceMonitor.endTimer('detailed-info');
      this.result.stepTimes['detailed-info'] = elapsedTime;
      this.logger.info(`‚úì Detailed info filled successfully`);
      this.logger.info(`‚è±Ô∏è  Step 3 completed in ${Math.round(elapsedTime/1000)}s`);

    } catch (error) {
      const elapsedTime = this.performanceMonitor.endTimer('detailed-info');
      this.logger.error(`‚úó Step 3 FAILED after ${Math.round(elapsedTime/1000)}s`);
      this.logger.error(`Error details: ${error.message}`);

      if (this.monitor) this.monitor.recordError(this.sessionId, 'step3-detailed', error);

      if (this.enableScreenshots) {
        try {
          await this.page.screenshot({ path: `public/screenshots/error-step3-${this.sessionId}.png` });
          this.logger.info('Error screenshot saved');
        } catch (screenshotError) {
          this.logger.warn('Failed to capture error screenshot');
        }
      }

      throw new Error(`Detailed info failed: ${error.message}`);
    }
  }

  /**
   * Step 4: ÏàòÍ∞ïÎ∞ò ÏÑ†ÌÉù
   */
  async _step4_SelectClassAndPayment() {
    this.logger.info('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    this.logger.info('üìù Step 4: Selecting class and payment');
    this.logger.info('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

    if (this.monitor) this.monitor.updateSessionStep(this.sessionId, 'step4-class');
    this.performanceMonitor.startTimer('class');

    try {
      // Ïù∏Ïä§ÌÑ¥Ïä§Î•º Î©§Î≤Ñ Î≥ÄÏàòÎ°ú Ï†ÄÏû•
      this.classSelectionPage = new ClassSelectionPage(this.page, this.sessionId);

      this.logger.info('Waiting for class selection page to load...');
      await this.classSelectionPage.waitForPageLoad();

      // ÎåÄÍ∏∞ ÌéòÏù¥ÏßÄ ÌôïÏù∏
      await this._handleWaitingPageIfPresent();

      this.logger.info('Selecting class and payment method...');
      const classInfo = await this._executeWithRateLimit('select-class-and-payment',
        () => this.classSelectionPage.selectClassAndPayment());
      this.result.classSelection = classInfo;

      // ÎåÄÍ∏∞ ÌéòÏù¥ÏßÄ ÌôïÏù∏
      await this._handleWaitingPageIfPresent();

      const elapsedTime = this.performanceMonitor.endTimer('class');
      this.result.stepTimes['class'] = elapsedTime;
      this.logger.info(`‚úì Class selected: ${classInfo.className || 'N/A'}`);
      this.logger.info(`üí∞ Fee: ${(classInfo.fee || 0).toLocaleString()}Ïõê`);
      this.logger.info(`‚è±Ô∏è  Step 4 completed in ${Math.round(elapsedTime/1000)}s`);

    } catch (error) {
      const elapsedTime = this.performanceMonitor.endTimer('class');
      this.logger.error(`‚úó Step 4 FAILED after ${Math.round(elapsedTime/1000)}s`);
      this.logger.error(`Error details: ${error.message}`);

      if (this.monitor) this.monitor.recordError(this.sessionId, 'step4-class', error);

      if (this.enableScreenshots) {
        try {
          await this.page.screenshot({ path: `public/screenshots/error-step4-${this.sessionId}.png` });
          this.logger.info('Error screenshot saved');
        } catch (screenshotError) {
          this.logger.warn('Failed to capture error screenshot');
        }
      }

      throw new Error(`Class/payment selection failed: ${error.message}`);
    }
  }

  /**
   * Step 5: Paymint Í≤∞Ï†ú Ï≤òÎ¶¨
   */
  async _step5_ProcessPayment() {
    this.logger.info('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    this.logger.info('üí≥ Step 5: Processing payment');
    this.logger.info('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

    if (this.monitor) this.monitor.updateSessionStep(this.sessionId, 'step5-payment');
    this.performanceMonitor.startTimer('payment');

    try {
      // Step 4ÏóêÏÑú ÏÉùÏÑ±Ìïú Ïù∏Ïä§ÌÑ¥Ïä§ Ïû¨ÏÇ¨Ïö©
      if (!this.classSelectionPage) {
        throw new Error('ClassSelectionPage not initialized. Step 4 must run first.');
      }

      // ÌåùÏóÖ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï (opener Ï≤¥ÌÅ¨Î°ú ÌòÑÏû¨ ÌÉ≠Ïùò ÌåùÏóÖÎßå Î∞õÏùå)
      this.logger.info('Setting up payment popup listener...');
      const popupPromise = new Promise((resolve, reject) => {
        const timeout = setTimeout(() => {
          this.page.context().off('page', pageHandler);
          reject(new Error('Payment popup wait timeout'));
        }, 15000);

        const pageHandler = (popup) => {
          // Check if popup belongs to THIS page
          popup.opener().then(opener => {
            if (opener === this.page) {
              clearTimeout(timeout);
              this.page.context().off('page', pageHandler);
              this.logger.info('‚úì Payment popup detected (matched by opener)');
              resolve(popup);
            }
          }).catch(() => {
            // Ignore errors from checking opener
          });
        };

        this.page.context().on('page', pageHandler);
      });

      // Í≤∞Ï†ú Î≤ÑÌäº ÌÅ¥Î¶≠
      this.logger.info('Clicking payment button...');
      await this._executeWithRateLimit('click-payment-button',
        () => this.classSelectionPage.clickPaymentButton());

      // ÎåÄÍ∏∞ ÌéòÏù¥ÏßÄ ÌôïÏù∏
      await this._handleWaitingPageIfPresent();

      // ÌåùÏóÖ ÎåÄÍ∏∞
      let paymentPage = null;
      try {
        paymentPage = await popupPromise;
        this.logger.info('‚úì Payment popup confirmed');
      } catch {
        this.logger.warn('No popup detected, using current page');
        paymentPage = this.page;
      }

      // ÌåùÏóÖÏù¥ Í∞êÏßÄÎêú Í≤ΩÏö∞ Ï≤òÎ¶¨
      if (paymentPage !== this.page) {
        const popupUrl = paymentPage.url();
        this.logger.info(`Payment popup URL: ${popupUrl}`);

        // paymint Í≤∞Ï†ú ÌéòÏù¥ÏßÄ ÌôïÏù∏
        if (popupUrl.includes('paymint.co.kr')) {
          this.logger.info('Paymint payment page detected, waiting for completion...');

          // "Í≤∞Ï†ú ÏôÑÎ£å" ÌÖçÏä§Ìä∏Í∞Ä ÎÇòÌÉÄÎÇ† ÎïåÍπåÏßÄ ÎåÄÍ∏∞ (ÏµúÎåÄ 60Ï¥à)
          try {
            await paymentPage.waitForSelector('text=Í≤∞Ï†ú ÏôÑÎ£å', { timeout: 60000 });
            this.logger.info('‚úì Payment completed successfully');
          } catch (waitError) {
            this.logger.warn('Payment completion text not found within timeout');

            // URLÏù¥ /complete/Î°ú Î≥ÄÍ≤ΩÎêòÏóàÎäîÏßÄ ÌôïÏù∏
            const currentUrl = paymentPage.url();
            if (currentUrl.includes('/complete/')) {
              this.logger.info('‚úì Payment URL changed to complete page');
            } else {
              // Í≤∞Ï†ú ÏôÑÎ£åÎ•º ÌôïÏù∏Ìï† Ïàò ÏóÜÏúºÎ©¥ ÏóêÎü¨ throw
              await paymentPage.close().catch(() => {});
              throw new Error(`Payment completion failed - still on: ${currentUrl}`);
            }
          }

          // ÌåùÏóÖ Îã´Í∏∞
          await this.page.waitForTimeout(2000);
          await paymentPage.close();
          this.logger.info('Payment popup closed');
          await this.page.waitForTimeout(2000);
        } else {
          this.logger.warn(`Unexpected popup URL: ${popupUrl}`);
          // ÏòàÏÉÅÏπò Î™ªÌïú ÌåùÏóÖÎèÑ Îã´Í∏∞
          await this.page.waitForTimeout(3000);
          await paymentPage.close();
          this.logger.info('Unexpected popup closed');
        }
      }

      const elapsedTime = this.performanceMonitor.endTimer('payment');
      this.result.stepTimes['payment'] = elapsedTime;
      this.logger.info(`‚è±Ô∏è  Step 5 completed in ${Math.round(elapsedTime/1000)}s`);

    } catch (error) {
      const elapsedTime = this.performanceMonitor.endTimer('payment');
      this.logger.error(`‚úó Step 5 FAILED after ${Math.round(elapsedTime/1000)}s`);
      this.logger.error(`Error details: ${error.message}`);

      if (this.monitor) this.monitor.recordError(this.sessionId, 'step5-payment', error);

      if (this.enableScreenshots) {
        try {
          await this.page.screenshot({ path: `public/screenshots/error-step5-${this.sessionId}.png` });
          this.logger.info('Error screenshot saved');
        } catch (screenshotError) {
          this.logger.warn('Failed to capture error screenshot');
        }
      }

      throw new Error(`Payment processing failed: ${error.message}`);
    }
  }
}
